---
title: "NORTA Unanchored STC Analysis: Comprehensive Example"
subtitle: "Advanced Methodology for Correlated Binary Covariates"
author: "Advanced STC Methods Package"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: show
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6,
  cache = TRUE
)

# Load required libraries
library(copula)
library(dplyr)
library(ggplot2)
library(knitr)
library(kableExtra)
library(plotly)

# Source NORTA STC analysis functions
source("norta_ustc_analysis.R")
```

# Introduction

This example demonstrates the **NORTA (NORmal To Anything) Unanchored STC Analysis**, an advanced methodology for simulated treatment comparison when dealing with **correlated binary covariates**. 

## Methodology Overview

The NORTA algorithm addresses a key challenge in unanchored STC: how to generate realistic patient profiles that preserve both:

1. **Marginal distributions** (e.g., 20% of patients have diabetes)
2. **Correlation structure** between covariates (e.g., diabetes and hypertension are correlated)

### Key Advantages

- **Preserves Correlations**: Maintains realistic relationships between baseline characteristics
- **Bootstrap Uncertainty**: Provides robust confidence intervals through resampling
- **Flexible Framework**: Can handle multiple binary covariates with complex correlation patterns
- **Validation Tools**: Built-in diagnostics to verify simulation quality

---

# Theoretical Background

## The NORTA Algorithm

NORTA uses a **Normal Copula** to generate correlated binary variables:

1. **Step 1**: Generate correlated normal random variables
2. **Step 2**: Transform to uniform using normal CDF
3. **Step 3**: Transform to binary using inverse binomial CDF
4. **Step 4**: Preserve target marginal probabilities and correlations

## Mathematical Framework

For binary variables $X_1, X_2$ with correlation $\rho_{12}$:

$$
\begin{pmatrix} Z_1 \\ Z_2 \end{pmatrix} \sim N\left(\begin{pmatrix} 0 \\ 0 \end{pmatrix}, \begin{pmatrix} 1 & \rho^* \\ \rho^* & 1 \end{pmatrix}\right)
$$

Where $\rho^*$ is the **normal copula parameter** that produces the desired binary correlation $\rho_{12}$.

---

# Example Analysis

## Scenario Setup

We'll analyze a realistic clinical scenario:

- **Index Trial**: New anticoagulant (Drug B) with IPD
- **Comparator Trial**: Standard warfarin (Drug A) with aggregate data
- **Outcome**: Major bleeding events (binary)
- **Covariates**: Age group, diabetes status (correlated)

```{r scenario-setup}
cat("=== NORTA UNANCHORED STC ANALYSIS EXAMPLE ===\n")
cat("Clinical Scenario: Anticoagulant bleeding risk comparison\n\n")

# Define scenario parameters
scenario_params <- list(
  # Study populations differ in baseline characteristics
  agd_probabilities = c(0.15, 0.25),    # Older population: 15% elderly, 25% diabetes
  ipd_probabilities = c(0.30, 0.35),    # Younger population: 30% elderly, 35% diabetes
  
  # Correlation structures (elderly and diabetes are positively correlated)
  agd_correlation = 0.3,                 # Moderate correlation in AgD population
  ipd_correlation = 0.3,                 # Similar correlation in IPD population
  
  # Logistic regression model parameters
  intercept = -2.5,                      # Baseline log-odds
  covariate_effects = c(                 # Covariate effects
    X1 = 0.6,    # Elderly status increases bleeding risk
    X2 = 0.4     # Diabetes increases bleeding risk
  ),
  treatment_effect = -0.5,               # Drug B reduces bleeding risk (log OR = -0.5)
  
  # Analysis settings
  covariates = c("X1", "X2"),           # Covariate names (X1=elderly, X2=diabetes)
  covariate_labels = c("Elderly (≥75y)", "Diabetes")
)

# Display scenario characteristics
cat("Population Characteristics:\n")
cat("AgD Population (Warfarin):\n")
cat("  Elderly (≥75y):", round(scenario_params$agd_probabilities[1] * 100, 1), "%\n")
cat("  Diabetes:", round(scenario_params$agd_probabilities[2] * 100, 1), "%\n")
cat("  Correlation:", scenario_params$agd_correlation, "\n\n")

cat("IPD Population (New Drug):\n")
cat("  Elderly (≥75y):", round(scenario_params$ipd_probabilities[1] * 100, 1), "%\n")
cat("  Diabetes:", round(scenario_params$ipd_probabilities[2] * 100, 1), "%\n")
cat("  Correlation:", scenario_params$ipd_correlation, "\n\n")

cat("True Treatment Effect:\n")
cat("  Log OR:", scenario_params$treatment_effect, "\n")
cat("  OR:", round(exp(scenario_params$treatment_effect), 3), "\n")
cat("  Interpretation: New drug reduces bleeding risk by", 
    round((1 - exp(scenario_params$treatment_effect)) * 100, 1), "%\n\n")
```

## Data Generation

### Generate Correlated Covariates

```{r generate-covariates}
set.seed(42)  # For reproducibility
n_patients <- 200

cat("Step 1: Generating correlated covariates using NORTA algorithm...\n")

# Generate NORTA covariates
norta_data <- generate_norta_covariates(
  n_patients = n_patients,
  covariate_type = "binary",
  agd_correlations = scenario_params$agd_correlation,
  ipd_correlations = scenario_params$ipd_correlation,
  agd_probabilities = scenario_params$agd_probabilities,
  ipd_probabilities = scenario_params$ipd_probabilities
)

# Display covariate summary
covariate_summary <- norta_data$combined_data %>%
  group_by(population, treatment) %>%
  summarise(
    n = n(),
    elderly_pct = round(mean(X1) * 100, 1),
    diabetes_pct = round(mean(X2) * 100, 1),
    correlation = round(cor(X1, X2), 3),
    .groups = "drop"
  )

cat("\nGenerated Covariate Summary:\n")
print(covariate_summary)
```

### Validate Correlation Structure

```{r validate-correlations}
cat("Step 2: Validating NORTA correlation structure...\n")

# Validate AgD correlations
agd_validation <- validate_norta_correlations(
  generated_data = norta_data$combined_data,
  target_correlations = matrix(c(1, scenario_params$agd_correlation, 
                                scenario_params$agd_correlation, 1), nrow = 2),
  population = "AgD"
)

# Validate IPD correlations  
ipd_validation <- validate_norta_correlations(
  generated_data = norta_data$combined_data,
  target_correlations = matrix(c(1, scenario_params$ipd_correlation,
                                scenario_params$ipd_correlation, 1), nrow = 2),
  population = "IPD"
)

# Create validation plot
validation_data <- data.frame(
  Population = rep(c("AgD", "IPD"), each = 1),
  Target_Correlation = c(scenario_params$agd_correlation, scenario_params$ipd_correlation),
  Achieved_Correlation = c(agd_validation$achieved_correlations[1,2], 
                          ipd_validation$achieved_correlations[1,2]),
  Error = c(agd_validation$achieved_correlations[1,2] - scenario_params$agd_correlation,
           ipd_validation$achieved_correlations[1,2] - scenario_params$ipd_correlation)
)

correlation_plot <- ggplot(validation_data, aes(x = Population)) +
  geom_col(aes(y = Target_Correlation), fill = "lightblue", alpha = 0.7, width = 0.4, position = position_nudge(x = -0.2)) +
  geom_col(aes(y = Achieved_Correlation), fill = "lightcoral", alpha = 0.7, width = 0.4, position = position_nudge(x = 0.2)) +
  geom_text(aes(y = Target_Correlation, label = round(Target_Correlation, 3)), 
            position = position_nudge(x = -0.2, y = 0.02), size = 3) +
  geom_text(aes(y = Achieved_Correlation, label = round(Achieved_Correlation, 3)), 
            position = position_nudge(x = 0.2, y = 0.02), size = 3) +
  labs(title = "NORTA Correlation Validation",
       subtitle = "Target (Blue) vs Achieved (Red) Correlations",
       y = "Correlation Coefficient",
       x = "Population") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

print(correlation_plot)
```

### Generate Clinical Outcomes

```{r generate-outcomes}
cat("Step 3: Generating clinical outcomes using logistic regression...\n")

# Generate outcomes using the defined model
complete_data <- generate_norta_outcomes(
  covariate_data = norta_data$combined_data,
  intercept = scenario_params$intercept,
  covariate_effects = scenario_params$covariate_effects,
  treatment_effect = scenario_params$treatment_effect
)

# Display outcome summary
outcome_summary <- complete_data %>%
  group_by(population, treatment) %>%
  summarise(
    n = n(),
    events = sum(outcome),
    event_rate_pct = round(mean(outcome) * 100, 1),
    .groups = "drop"
  )

cat("\nGenerated Outcome Summary:\n")
print(outcome_summary)

# Create outcome visualization
outcome_plot <- ggplot(outcome_summary, aes(x = interaction(treatment, population), y = event_rate_pct)) +
  geom_col(aes(fill = treatment), alpha = 0.7, width = 0.6) +
  geom_text(aes(label = paste0(event_rate_pct, "%\n(", events, "/", n, ")")), 
            vjust = -0.3, size = 3) +
  scale_fill_manual(values = c("A" = "lightblue", "B" = "lightcoral")) +
  labs(title = "Event Rates by Treatment and Population",
       x = "Treatment.Population",
       y = "Event Rate (%)",
       fill = "Treatment") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"),
        axis.text.x = element_text(angle = 45, hjust = 1))

print(outcome_plot)
```

---

# NORTA Unanchored STC Analysis

## Prepare Data for Analysis

```{r prepare-data}
cat("Step 4: Preparing data for unanchored STC analysis...\n")

# Extract IPD data (treatment B from IPD population)
ipd_data <- complete_data %>%
  filter(population == "IPD", treatment == "B") %>%
  select(all_of(scenario_params$covariates), outcome)

cat("IPD Data (Treatment B):\n")
cat("  Sample size:", nrow(ipd_data), "\n")
cat("  Events:", sum(ipd_data$outcome), "\n")
cat("  Event rate:", round(100 * mean(ipd_data$outcome), 1), "%\n\n")

# Extract AgD summary data (treatment A from AgD population)
agd_data_a <- complete_data %>%
  filter(population == "AgD", treatment == "A")

agd_summary <- list(
  n_patients = nrow(agd_data_a),
  n_events = sum(agd_data_a$outcome),
  X1 = mean(agd_data_a$X1),  # Proportion elderly
  X2 = mean(agd_data_a$X2)   # Proportion diabetes
)

cat("AgD Summary Data (Treatment A):\n")
cat("  Sample size:", agd_summary$n_patients, "\n")
cat("  Events:", agd_summary$n_events, "\n")
cat("  Event rate:", round(100 * agd_summary$n_events / agd_summary$n_patients, 1), "%\n")
cat("  Elderly proportion:", round(agd_summary$X1, 3), "\n")
cat("  Diabetes proportion:", round(agd_summary$X2, 3), "\n\n")
```

## Run NORTA STC Analysis

```{r norta-stc-analysis}
cat("Step 5: Running NORTA unanchored STC analysis...\n")

# Run the analysis with moderate bootstrap for demonstration
# (In practice, use n_bootstrap = 1000+ for final analysis)
stc_results <- norta_unanchored_stc_analysis(
  ipd_data = ipd_data,
  agd_summary = agd_summary,
  covariates = scenario_params$covariates,
  n_bootstrap = 500,  # Reduced for demonstration speed
  n_simulation = 5000  # Reduced for demonstration speed
)

# Extract key results
log_or <- stc_results$treatment_effects$log_odds_ratio
or <- stc_results$treatment_effects$odds_ratio
or_ci_lower <- stc_results$treatment_effects$or_ci_lower
or_ci_upper <- stc_results$treatment_effects$or_ci_upper
p_value <- stc_results$treatment_effects$p_value

cat("\n=== NORTA STC RESULTS SUMMARY ===\n")
cat("Treatment Effect (New Drug vs Warfarin):\n")
cat("  Log Odds Ratio:", round(log_or, 3), "\n")
cat("  Odds Ratio:", round(or, 3), "\n")
cat("  95% CI: (", round(or_ci_lower, 3), ", ", round(or_ci_upper, 3), ")\n")
cat("  P-value:", round(p_value, 4), "\n\n")

# Clinical interpretation
risk_reduction <- (1 - or) * 100
if (or < 1 && p_value < 0.05) {
  cat("CLINICAL INTERPRETATION:\n")
  cat("The new drug shows a statistically significant", round(risk_reduction, 1), 
      "% reduction\nin bleeding risk compared to warfarin (p =", round(p_value, 4), ").\n\n")
} else if (or < 1) {
  cat("CLINICAL INTERPRETATION:\n")
  cat("The new drug shows a", round(risk_reduction, 1), 
      "% reduction in bleeding risk,\nbut this is not statistically significant (p =", round(p_value, 4), ").\n\n")
} else {
  cat("CLINICAL INTERPRETATION:\n")
  cat("The new drug does not show a reduction in bleeding risk.\n\n")
}
```

## Validation and Diagnostics

```{r validation-diagnostics}
cat("Step 6: Validation and bias assessment...\n")

# Calculate true treatment effect for validation
true_effect <- calculate_true_marginal_effect(complete_data, scenario_params)

# Calculate bias metrics
estimated_log_or <- stc_results$treatment_effects$log_odds_ratio
bias <- estimated_log_or - true_effect
relative_bias <- (bias / true_effect) * 100

# Create bias assessment table
bias_assessment <- data.frame(
  Metric = c("True Effect (Log OR)", "Estimated Effect", "Absolute Bias", "Relative Bias (%)"),
  Value = c(round(true_effect, 4), round(estimated_log_or, 4), 
           round(bias, 4), round(relative_bias, 1))
)

cat("\nBias Assessment:\n")
print(bias_assessment)

# Bootstrap distribution visualization
bootstrap_data <- data.frame(
  bootstrap_log_or = stc_results$bootstrap_results
)

bootstrap_plot <- ggplot(bootstrap_data, aes(x = bootstrap_log_or)) +
  geom_histogram(bins = 50, fill = "skyblue", alpha = 0.7, color = "white") +
  geom_vline(xintercept = true_effect, color = "red", linetype = "dashed", size = 1) +
  geom_vline(xintercept = estimated_log_or, color = "blue", linetype = "solid", size = 1) +
  annotate("text", x = true_effect, y = Inf, label = "True Effect", 
           vjust = 1.5, hjust = -0.1, color = "red", size = 3) +
  annotate("text", x = estimated_log_or, y = Inf, label = "Estimated", 
           vjust = 1.5, hjust = 1.1, color = "blue", size = 3) +
  labs(title = "Bootstrap Distribution of Treatment Effect Estimates",
       subtitle = paste("Based on", length(stc_results$bootstrap_results), "bootstrap samples"),
       x = "Log Odds Ratio",
       y = "Frequency") +
  theme_minimal() +
  theme(plot.title = element_text(size = 14, face = "bold"))

print(bootstrap_plot)

# Bias interpretation
if (abs(relative_bias) < 5) {
  cat("\n✅ EXCELLENT PERFORMANCE: Relative bias <5%\n")
  cat("The NORTA STC method provides an accurate estimate.\n")
} else if (abs(relative_bias) < 10) {
  cat("\n✅ GOOD PERFORMANCE: Relative bias <10%\n") 
  cat("The NORTA STC method provides a reasonably accurate estimate.\n")
} else {
  cat("\n⚠️  MODERATE BIAS: Relative bias ≥10%\n")
  cat("Consider increasing bootstrap samples or checking model assumptions.\n")
}
```

---

# Results Summary

## Treatment Effect Estimate

```{r results-summary}
# Create results summary table
results_table <- data.frame(
  Analysis = "NORTA Unanchored STC",
  `Log OR` = round(stc_results$treatment_effects$log_odds_ratio, 3),
  `Odds Ratio` = round(stc_results$treatment_effects$odds_ratio, 3),
  `95% CI Lower` = round(stc_results$treatment_effects$or_ci_lower, 3),
  `95% CI Upper` = round(stc_results$treatment_effects$or_ci_upper, 3),
  `P-value` = round(stc_results$treatment_effects$p_value, 4),
  `Bias (%)` = round(relative_bias, 1),
  check.names = FALSE
)

kable(results_table, 
      caption = "NORTA Unanchored STC Analysis Results",
      align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c("Analysis" = 1, "Treatment Effect" = 4, "Statistics" = 2))
```

## Key Findings

### Clinical Significance

The NORTA unanchored STC analysis demonstrates:

1. **Treatment Effect**: The new anticoagulant shows an estimated `r round((1-or)*100, 1)`% reduction in bleeding risk compared to warfarin

2. **Statistical Significance**: The effect is `r ifelse(p_value < 0.05, "statistically significant", "not statistically significant")` (p = `r round(p_value, 4)`)

3. **Precision**: The 95% confidence interval ranges from `r round((1-or_ci_upper)*100, 1)`% to `r round((1-or_ci_lower)*100, 1)`% risk reduction

### Methodological Performance

1. **Bias Assessment**: The NORTA method achieved `r round(abs(relative_bias), 1)`% relative bias, indicating `r ifelse(abs(relative_bias) < 5, "excellent", ifelse(abs(relative_bias) < 10, "good", "moderate"))` performance

2. **Correlation Preservation**: Successfully maintained target correlation structure between baseline characteristics

3. **Bootstrap Uncertainty**: Provided robust confidence intervals through `r stc_results$study_info$n_bootstrap` bootstrap iterations

---

# Technical Notes

## When to Use NORTA STC

The NORTA methodology is particularly valuable when:

- **Binary covariates** are important effect modifiers
- **Correlation structure** between covariates matters for the clinical question  
- **Population differences** exist in both marginal probabilities and correlations
- **Regulatory standards** require robust uncertainty quantification

## Limitations and Considerations

1. **Computational Intensity**: Bootstrap resampling requires substantial computation time
2. **Binary Variables Only**: Current implementation focuses on binary covariates
3. **Correlation Assumptions**: Assumes correlation structure from IPD applies to AgD population
4. **Sample Size Requirements**: Requires adequate IPD sample size for stable correlation estimation

## Implementation Details

- **Bootstrap Samples**: `r stc_results$study_info$n_bootstrap` iterations used
- **Simulation Size**: `r stc_results$study_info$n_simulation` patients per bootstrap
- **Correlation Validation**: Built-in diagnostics ensure target correlations achieved
- **Bias Assessment**: Comparison with known true effect when available

---

# Conclusion

This example demonstrates the NORTA unanchored STC methodology for analyzing correlated binary covariates. The approach successfully:

1. **Preserved correlation structure** between baseline characteristics
2. **Provided unbiased treatment effect estimates** with robust uncertainty quantification  
3. **Demonstrated clinical interpretability** with clear risk reduction metrics
4. **Included comprehensive validation** tools for quality assurance

The NORTA method represents an important advancement in unanchored STC methodology, particularly for clinical scenarios where covariate correlations play a crucial role in treatment effect estimation.

```{r session-info}
cat("=== SESSION INFORMATION ===\n")
sessionInfo()
``` 